name: Run MCP tests

on:
  workflow_dispatch:  # Manual trigger only - redundant with quality_control.yml

jobs:
  test-mcps:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        mcp:
          - name: "adios"
            path: "agent-toolkit-mcp-servers/adios"
          - name: "arxiv"
            path: "agent-toolkit-mcp-servers/arxiv"
          - name: "compression"
            path: "agent-toolkit-mcp-servers/compression"
          - name: "darshan"
            path: "agent-toolkit-mcp-servers/darshan"
          - name: "hdf5"
            path: "agent-toolkit-mcp-servers/hdf5"
          - name: "jarvis"
            path: "agent-toolkit-mcp-servers/jarvis"
          - name: "lmod"
            path: "agent-toolkit-mcp-servers/lmod"
          - name: "node-hardware"
            path: "agent-toolkit-mcp-servers/node-hardware"
          - name: "pandas"
            path: "agent-toolkit-mcp-servers/pandas"
          - name: "parallel-sort"
            path: "agent-toolkit-mcp-servers/parallel-sort"
          - name: "paraview"
            path: "agent-toolkit-mcp-servers/paraview-mcp"
          - name: "parquet"
            path: "agent-toolkit-mcp-servers/parquet"
          - name: "plot"
            path: "agent-toolkit-mcp-servers/plot"
          - name: "slurm"
            path: "agent-toolkit-mcp-servers/slurm"

    name: Test ${{ matrix.mcp.name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      
    - name: Install Slurm dependencies
      if: matrix.mcp.name == 'slurm'
      run: |
        sudo apt-get update
        sudo apt-get install -y slurm-wlm

    - name: Run tests for ${{ matrix.mcp.name }}
      working-directory: ${{ matrix.mcp.path }}
      run: |
        uv run pytest --tb=short -v

